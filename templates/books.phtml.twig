{% include "/shared/topbar.phtml.twig" %}

<head>
    <style></style>
</head>

<body>
    <br>

    <h2 class="text-center">Books</h2>

    <br>
    <br>

    <div class="collapse text-center" id="FilterCollapsable" style="width: 60%; margin:auto;">
        <form action="/books" class="text-center" method="GET">
            <div class="form-group" style="">
                <label class="fw-bold" for="TitleInput" style="float: left;">Search Title</label>

                <input type="text" name="SearchTitle" class="form-control" id="TitleInput" aria-describedby="TitleHelp" placeholder="Enter book title"

                        {% if SearchTitle is defined %}
                           value="{{ SearchTitle }}"
                        {% endif %}
                >
            </div>

            <br>

            <div class="form-group" style="">
                <label class="fw-bold" for="ExternalSearchInput1" style="left: 0; float: left; margin: 0;">External Search</label>
                <br>
                <input name="ExternalSearch" class="form-check-input" type="checkbox" style="float: left; left: 0; margin: 0;" value="true" id="ExternalSearchInput1"{% if ExternalSearch is defined and ExternalSearch == "true" %}
                    checked {% endif %}
                >
                <br>
            </div>

            <br>

            <div class="form-group dropdown" style="float: left;">
                    <button class="btn

                    {% if (SelectedGenres is defined) and (SelectedGenres is not empty) %}
                        btn-primary
                    {% else %}
                        btn-light
                    {% endif %}


                    dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Genres

                        {% if (SelectedGenres is defined) and (SelectedGenres is not empty) %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                {{ SelectedGenres|length }}
                                <span class="visually-hidden">Selected Genres</span>
                            </span>
                        {% endif %}
                    </button>
                    <ul class="dropdown-menu">

                        {% for genre, genreInfo in Genres  %}
                            <a class="dropdown-item
                            {% if (SelectedGenres is defined) and (genre in SelectedGenres ) %}
                                active
                            {% endif %}
                            " href="/books?Genre={{ genre }}{% if SearchTitle is defined %}&SearchTitle={{ SearchTitle }}{% endif %}{% if ExternalSearch is defined %}&ExternalSearch={{ ExternalSearch }}{% endif %}">{{ genre }}</a>
                        {% endfor %}

                    </ul>

                <p id="DropdownHelp" class="form-text" style="float: left; margin-left: 1rem;"></p>

            </div>

            <br>
            <br>
            <div>
                <input type="submit" class="btn btn-success" style="display: inline-block;" value="Apply Filters"/>
                <input type="submit" name="RandomSearch" class="btn btn-primary" style="display: inline-block;" value="I'm feeling lucky"/>
            </div>
        </form>



        <br>

        {% if (SelectedGenres is defined) and (SelectedGenres is not empty) %}
            <label class="fw-bold" style="">Applied Genres</label>
        {% endif %}

        <br>
        <br>

        {% for genre in SelectedGenres %}
            <form action="/books" method="POST" style="display: inline-block;">
                {% if SearchTitle is defined %}
                    <input type="hidden" name = "SearchTitle" value="{{ SearchTitle }}"/>
                {% endif %}

                <input type="hidden" name="ExternalSearch" value="{{ ExternalSearch ?? "false" }}">

                <input type="hidden" name="removeGenre" value="{{ genre }}"/>
                <input type="submit" class="btn btn-{{ Genres[genre].ButtonType }} btn-sm fw-bold" value="{{ genre }} ðŸ—™"/>
            </form>
        {% endfor %}
    </div>

    <div class="text-center">
        <button class="btn

        {% if ((SelectedGenres is defined) and (SelectedGenres is not empty)) or (SearchTitle is defined) %}
            btn-primary
        {% else %}
            btn-secondary
        {% endif %}

        " style="margin: auto;" data-bs-toggle="collapse" data-bs-target="#FilterCollapsable">Filters</button>
    </div>

    <br>

    <div class="text-center" style="width: 80%; margin: auto;">
        <h3 style="float: left;"> All books | Page: {{ PageNumber }} / {{ MaxPageNumber }} </h3>

        <br>

        <table class="table table-dark">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Cover</th>
                    <th scope="col">Title</th>
                    <th scope="col">Genre</th>
                    <th scope="col">Author</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for Index, Book in Books %}
                    <div class="modal fade" id="ConfirmDelete{{ Index }}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalLabel">Confirm logout</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>

                                <form action="/deleteBook" method="POST">
                                    {% if SearchTitle is defined %}
                                        <input type="hidden" name = "BookTitle" value="{{ SearchTitle }}"/>
                                    {% endif %}

                                    <input type="hidden" name="BookId" id="BookId" value="{{ Book.Id }}">
                                    <input type="hidden" name="BookTitle" id="BookTitle" value="{{ Book.Title }}">

                                    <div class="modal-body">
                                        <p>Are you sure you want to delete <strong>'{{ Book.Title }}'</strong>?</p>
                                    </div>

                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <input type="submit" class="btn btn-danger" value="Delete">
                                    </div>
                                </form>

                            </div>
                        </div>
                    </div>


                    <tr>
                        <td> {{ ((PageNumber - 1) * Site["MaxItemsPerPage"]) + Index}}  </td>
                        <td> <img src="{{ Book.ImageURL }}" style="width: 10rem; height: 10rem;" class="img-fluid" alt=""> </td>
                        <td> {{ Book.Title }} </td>


                        <td>
                            {% if Genres[Book.Genre] is defined  %}
                                <div class="btn btn-sm fw-bold btn-{{Genres[Book.Genre].ButtonType}}">{{ Book.Genre }}</div>
                            {% else %}
                                <script>console.log("GENRE: {{ Book.Genre }} NOT FOUND!");</script>
                                <div class="btn btn-sm fw-bold btn-secondary">{{ Book.Genre }}</div>
                            {% endif %}
                        </td>


                        <td> {{ Book.Author }}</td>
                        <td>

                            {% if not Book.IsExternal %}
                                <form action="/reviews" method="GET">
                                    {% if SearchTitle is defined %}
                                        <input type="hidden" name = "SearchTitle" value="{{ SearchTitle }}"/>
                                    {% endif %}

                                    <input type="hidden" name="BookTitle" id="BookTitle" value="{{ Book.Title }}">
                                    <input type="submit" class="btn btn-success" value="Reviews">
                                </form>


                                {% if User.usertype.level > 1 %}
                                    <button class="btn btn-danger" value="Delete" data-bs-target="#ConfirmDelete{{ Index }}" data-bs-toggle="modal">Delete</button>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>


    {% if Books is empty and (SearchTitle is defined and SearchTitle != "") and (not ExternalSearch is defined or ExternalSearch == "false") %}
        <form action="/books" method="GET" class="text-center">
            {% if SearchTitle is defined %}
                <input type="hidden" name = "SearchTitle" value="{{ SearchTitle }}"/>
            {% endif %}

            <input type="hidden" name="ExternalSearch" value="true">
            <input type="hidden" name="PageNumber" value="{{ PageNumber }}"/>
            <input type="submit" class="btn btn-primary" value="SEARCH GOOGLE BOOKS"/>
        </form>
    {% endif %}

    <div class="text-center">

        <ul style="list-style: none; ">
            {% set currentPageNumber = PageNumber %}
            {% for i in 3 .. 1 %}
                {% set currentPageNumber = PageNumber - i %}
                {% if currentPageNumber >= 1 %}
                    <li style= "display: inline-block">
                        <form action="/books" method="GET">
                            {% if SearchTitle is defined %}
                                <input type="hidden" name = "SearchTitle" value="{{ SearchTitle }}"/>
                            {% endif %}

                            <input type="hidden" name="ExternalSearch" value="{{ ExternalSearch ?? "false" }}">
                            <input type="hidden" name="PageNumber" value="{{ currentPageNumber }}"/>
                            <input type="submit" class="btn btn-light" value="{{ currentPageNumber }}"/>
                        </form>
                    </li>
                {% endif %}
            {% endfor %}

            <li style="display: inline-block">
                <form action="/books" method="GET">
                    {% if SearchTitle is defined %}
                        <input type="hidden" name = "SearchTitle" value="{{ SearchTitle }}"/>
                    {% endif %}

                    <input type="hidden" name="PageNumber" value="{{ PageNumber }}"/>
                    <input type="hidden" name="ExternalSearch" value="{{ ExternalSearch ?? "false" }}">
                    <input type="submit" class="btn btn-secondary" value="{{ PageNumber }}"/>
                </form>
            </li>

            {% set currentPageNumber = PageNumber %}
            {% for i in 1 .. 3 %}
                {% set currentPageNumber = PageNumber + i %}

                {% if currentPageNumber <= MaxPageNumber %}

                    <li style="display: inline-block">
                        <form action="/books" method="GET">
                            {% if SearchTitle is defined %}
                                <input type="hidden" name = "SearchTitle" value="{{ SearchTitle }}"/>
                            {% endif %}

                            <input type="hidden" name="PageNumber" value="{{ currentPageNumber }}"/>
                            <input type="hidden" name="ExternalSearch" value="{{ ExternalSearch ?? "false" }}">
                            <input type="submit" class="btn btn-light" value="{{ currentPageNumber }}"/>
                        </form>
                    </li>

                {% endif %}
            {% endfor %}

        </ul>
    </div>
</body>

